import software.amazon.awssdk.services.s3.model.ListObjectsV2Request;
import software.amazon.awssdk.services.s3.model.ListObjectsV2Response;
import software.amazon.awssdk.services.s3.model.PutObjectRequest;
import software.amazon.awssdk.services.s3.model.DeleteObjectRequest;
import software.amazon.awssdk.services.s3.model.S3Object;
import software.amazon.awssdk.core.sync.RequestBody;

import java.io.InputStream;
import java.io.IOException;
import java.util.Comparator;
import java.util.Date;
import java.util.List;

public void pushFile(InputStream inputStream) throws IOException {
    // Step 1: List all the objects in the "NWM_Validations" folder
    ListObjectsV2Request listObjectsRequest = ListObjectsV2Request.builder()
        .bucket(s3Configuration.getBucketname())
        .prefix("NWM_Validations/") // Folder path
        .build();

    ListObjectsV2Response listObjectsResponse = s3.listObjectsV2(listObjectsRequest);
    List<S3Object> s3Objects = listObjectsResponse.contents();

    // Step 2: Sort the objects by last modified date in descending order (latest first)
    s3Objects.sort(Comparator.comparing(S3Object::lastModified).reversed());

    // Step 3: Keep only the latest 3 and delete the rest
    if (s3Objects.size() > 3) {
        for (int i = 3; i < s3Objects.size(); i++) {
            String fileKey = s3Objects.get(i).key();

            DeleteObjectRequest deleteObjectRequest = DeleteObjectRequest.builder()
                .bucket(s3Configuration.getBucketname())
                .key(fileKey)
                .build();

            // Delete the older file
            s3.deleteObject(deleteObjectRequest);
            System.out.println("Deleted old file: " + fileKey);
        }
    }

    // Step 4: Add the new file to the bucket
    Date today = new Date();
    String folderName = "NWM_Validations/Business_validation_" + today.toInstant() + ".xlsx";

    PutObjectRequest putObjectRequest = PutObjectRequest.builder()
        .bucket(s3Configuration.getBucketname())
        .key(folderName)
        .build();

    s3.putObject(putObjectRequest, RequestBody.fromInputStream(inputStream, inputStream.available()));
    System.out.println("New file uploaded: " + folderName);
}
